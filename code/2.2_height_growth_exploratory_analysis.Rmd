---
title: "Untitled"
output: html_document
date: "2024-01-17"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(lubridate)
library(lme4)
library(lmerTest)
```

```{r}
temperature <- read.csv(here("data", "clean_data", "temperature.csv")) %>% 
  dplyr::select(!X) %>% 
  mutate(month = month(date))

vpd <- read.csv(here("data", "clean_data", "vpd.csv")) %>% 
  dplyr::select(!X) %>% 
  mutate(month = month(date))

max_temperature <- temperature %>% 
  group_by(plot, rep, date) %>% 
  reframe(temperature = max(temperature)) %>% 
  mutate(month = month(date)) %>% 
  filter(month >= 6) %>% 
  group_by(plot) %>% 
  reframe(temperature = mean(temperature))

max_vpd <- vpd %>% 
  group_by(plot, rep, date) %>% 
  reframe(vpd = max(vpd)) %>% 
  mutate(month = month(date)) %>% 
  filter(month >= 6) %>% 
  group_by(plot) %>% 
  reframe(vpd = mean(vpd))

plant_traits <- read.csv(here("data", "clean_data", "analysis_traits.csv")) %>% 
  mutate(wood_density = scale(wood_density)[,1],
         wue = scale(wue)[,1])

community_type <- read.csv(here("data", "raw_data", "community_types.csv"))
cover <- read.csv(here("data", "clean_data", "percent_cover_clean.csv")) %>% 
  select(!X) %>% 
  filter(species == "Sage" | (group == "sage" & date == "2023-06-01")) %>% 
  group_by(plot, group, date) %>% 
  reframe(cover = sum(percent_cover, na.rm = T)) %>% 
  mutate(month = month(date))

survival_data <- read.csv(here("data", "clean_data", "kaplan_survival_data.csv")) %>% 
  select(!X) %>% 
  mutate(month = month(start_date),
         year = year(start_date))

survival_sum <- survival_data %>% 
  filter(end_date == "2023-05-17") %>% 
  mutate(alive = case_when(dead == 0 ~ 1,
                           dead == 1 ~ 0)) %>% 
  group_by(plot) %>% 
  reframe(plants_alive = sum(alive))

cover_march <- cover %>% 
  filter(month == 3)

cover_june <- cover %>% 
  filter(month == 6)
height <- read.csv(here("data", "clean_data", "height_clean.csv")) %>% 
  mutate(date = mdy(date),
         month = month(date)) %>% 
  left_join(community_type, by = "plot")
height$community <- factor(height$community, levels = c(3,2,1))

growth_sep <- height %>% 
  filter(month %in% c(5,9)) %>% 
  mutate(month = case_when(month == 5 ~ "may",
                           month == 9 ~ "september")) %>% 
  select(!X & !date) %>% 
  pivot_wider(values_from = height_cm, names_from = month) %>% 
  drop_na(september) %>% 
  drop_na(may) %>% 
  drop_na(id) %>% 
  mutate(may = as.numeric(may),
         september = as.numeric(september),
         growth = september-may, 
         species = tolower(species)) %>% 
  left_join(survival_sum, by = "plot") %>% 
  left_join(max_temperature, by = "plot") %>% 
  left_join(max_vpd, by = "plot") %>% 
  left_join(plant_traits, by = "species")
  
```

```{r}
summary(lmer(growth~ les_1 + plants_alive + (1|plot), data = growth_sep))


summary(lmer(growth~ les_2 + plants_alive + (1|plot), data = growth_sep))


summary(lmer(growth~ wood_density + plants_alive + (1|plot), data = growth_sep))


summary(lmer(growth~ wue + plants_alive + (1|plot), data = growth_sep))
```





