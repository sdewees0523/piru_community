---
title: "Untitled"
output: html_document
date: "2024-01-12"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(survival)
library(lubridate)
library(ggsurvfit)
library(gtsummary)
library(survminer)
library(ggfortify)
library(coxme)
library(patchwork)
<<<<<<< HEAD
library(lme4)
library(lmerTest)
=======
>>>>>>> 8782b0b8e2a1e7c27dac0a6767089b0791bd066f
```

```{r}
survival_data <- read.csv(here("data", "clean_data", "kaplan_survival_data.csv")) %>% 
  select(!X) %>% 
  mutate(month = month(start_date),
         year = year(start_date))

survival_sum <- survival_data %>% 
  filter(start_time == 0) %>% 
  mutate(alive = case_when(dead == 0 ~ 1,
                           dead == 1 ~ 0)) %>% 
  group_by(plot) %>% 
  reframe(plants_alive = sum(alive))


survival_density <- survival_data %>% 
  filter(start_time != 0 & end_time < 365) %>% 
  left_join(survival_sum, by = "plot")

par <- read.csv(here("data", "clean_data", "par_clean.csv")) %>% 
  select(!X) %>% 
  group_by(plot, date) %>% 
  reframe(par = mean(par, na.rm = T)) %>% 
  mutate(month = month(date),
         year = year(date)) %>% 
  group_by(date, month, year) %>% 
  mutate(par = scale(par)) %>% 
  ungroup()

soil_moisture <- read.csv(here("data", "clean_data", "soil_moisture_clean.csv")) %>% 
  select(!X) %>%
  group_by(plot, date) %>% 
  reframe(soil_moisture = mean(soil_moisture, na.rm = T)) %>% 
  mutate(month = month(date),
         year = year(date)) %>% 
  drop_na() %>% 
  group_by(date, month, year) %>% 
  mutate(soil_moisture = scale(soil_moisture)) %>% 
  ungroup()

survival_environmental <- survival_density %>% 
  left_join(par, by = c("plot", "month", "year")) %>% 
  left_join(soil_moisture, by = c("plot", "month", "year")) %>% 
  mutate(community = as.factor(community)) %>% 
  filter(end_time < 365)

<<<<<<< HEAD
plant_traits <- read.csv(here("data", "clean_data", "analysis_traits.csv")) %>% 
  mutate(wood_density = scale(wood_density),
         wue = scale(wue))

survival_environmental_traits <- survival_density %>% 
  left_join(par, by = c("plot", "month", "year")) %>% 
  left_join(soil_moisture, by = c("plot", "month", "year")) %>% 
  left_join(plant_traits, by = "species") %>% 
=======
plant_traits <- read.csv(here("data", "clean_data", "chaparral_traits_clean.csv"))

leaf_traits_pca_input <- plant_traits %>% 
  dplyr::select(sla, 
                ldmc, 
                leaf_thickness, 
                petiole_length,
                leaf_lamina_length,
                leaf_width,
                leaf_c_n,
                leaf_n_area,
                leaf_c_area)

leaf_traits_pca <- prcomp(leaf_traits_pca_input, scale = T)

les_plant_traits <- plant_traits %>% 
  mutate(les_1 = predict(leaf_traits_pca, newdata = .)[,1],
         les_2 = predict(leaf_traits_pca, newdata = .)[,2]) %>% 
  select(species, les_1, les_2, wood_density, wue) %>% 
  mutate(wood_density = scale(wood_density))

survival_environmental_traits <- survival_density %>% 
  left_join(par, by = c("plot", "month", "year")) %>% 
  left_join(soil_moisture, by = c("plot", "month", "year")) %>% 
  left_join(les_plant_traits, by = "species") %>% 
>>>>>>> 8782b0b8e2a1e7c27dac0a6767089b0791bd066f
  mutate(community = as.factor(community)) %>%
  filter(end_time < 365)
```

```{r}
<<<<<<< HEAD
carla_input <- survival_density %>% 
  group_by(plot, id) %>% 
  filter(end_time == max(end_time)) %>% 
  ungroup() %>% 
  mutate(density = plants_alive/25, 
         alive = case_when(dead == 1 ~ 0,
                           dead == 0 ~ 1),
         community_type = case_when(community_type == "sage" ~ "sage scrub",
                                    community_type == "chap" ~ "chaparral"))
summary(glmer(alive~density + (1|plot), family = "binomial", data = carla_input %>% filter(community_type == "sage")))
summary(glmer(alive~density + (1|plot), family = "binomial", data = carla_input %>% filter(community_type == "chap")))


carla_plot <- ggplot(carla_input, aes(x= density, y = alive, col = community_type))+
  geom_point()+
  scale_color_manual(values = c("#548235", "#2E75B6")) + 
  geom_smooth(method = "glm",
              method.args = list("binomial"))+
  theme_classic()+
  labs(x = "Initial Density (plants/m2)",
       y = "Alive",
       col = "Vegetation \n Community")

ggsave(filename = "carla_plot.png",
       plot = carla_plot,
       path = here("figures"),
       width = 8,
       height = 8,
       units = "in")
```

```{r}
transplant_environment <- survival_sum %>% 
  left_join(soil_moisture, by = "plot") %>% 
  filter(month == 2) %>% 
  left_join(par, by = c("plot", "month"))

summary(glm(plants_alive~soil_moisture + par, family = "Gamma", data = transplant_environment))

ggplot(soil_moisture, aes(x = date, y = soil_moisture, col = as.factor(plot), group = plot))+
  geom_point()+
  geom_line()

summary(aov(soil_moisture~as.factor(plot), soil_moisture))

ggplot(transplant_environment, aes(x = soil_moisture, y = plants_alive))+
  geom_point()+
  geom_smooth(method = "glm",
              method.args = list("Gamma"))+
  theme_classic()
```

```{r}
soil_moisture_wide <- soil_moisture %>% 
  mutate(month = case_when(month == 2 ~"february",
                           month == 4 ~ "april",
                           month == 5 ~ "may",
                           month == 6 ~ "june",
                           month == 7 ~ "july",
                           month == 9 ~ "september",
                           month == 10 ~ "october",
                           month == 11 ~ "november")) %>% 
  filter(year == 2022) %>% 
  select(plot, soil_moisture, month) %>% 
  pivot_wider(names_from = month, values_from = soil_moisture)

summary(glm(april~february, data = soil_moisture_wide))
summary(glm(may~february, data = soil_moisture_wide))
summary(glm(june~february, data = soil_moisture_wide))
summary(glm(july~february, data = soil_moisture_wide))
summary(glm(september~february, data = soil_moisture_wide))
summary(glm(october~february, data = soil_moisture_wide))
summary(glm(november~february, data = soil_moisture_wide))


```




```{r}
cox_all <- coxme(Surv(start_time, end_time, dead) ~ plants_alive + (1|plot), data = survival_density %>% filter(dead == 1 |end_date == "2022-11-21") %>% mutate(start_time = 0)) %>%  tbl_regression(exp = T)

cox_all_estimates <- data_frame("group" = "whole plot", 
                                "hazard_ratio" = cox_all$table_body$estimate, 
                                "lower" = cox_all$table_body$conf.low, 
                                "upper" = cox_all$table_body$conf.high,
                                "pvalue" = round(cox_all$table_body$p.value, digits = 3))

=======
cox_all <- coxme(Surv(start_time, end_time, dead) ~ plants_alive + (1|plot), data = survival_density %>% filter(dead == 1 |end_date == "2022-11-21") %>% mutate(start_time = 0)) %>%  tbl_regression(exp = T)

cox_all_estimates <- data_frame("group" = "whole plot", 
                                "hazard_ratio" = cox_all$table_body$estimate, 
                                "lower" = cox_all$table_body$conf.low, 
                                "upper" = cox_all$table_body$conf.high,
                                "pvalue" = round(cox_all$table_body$p.value, digits = 3))

>>>>>>> 8782b0b8e2a1e7c27dac0a6767089b0791bd066f
cox_sage <- coxme(Surv(start_time, end_time, dead) ~ plants_alive + (1|plot), data = survival_density %>% filter(community_type == "sage") %>% 
        filter(dead == 1 |end_date == "2022-11-21") %>%  mutate(start_time = 0)) %>% tbl_regression(exp = T)

cox_sage_estimates <- data_frame("group" = "sage scrub", 
                                "hazard_ratio" = cox_sage$table_body$estimate, 
                                "lower" = cox_sage$table_body$conf.low, 
                                "upper" = cox_sage$table_body$conf.high,
                                "pvalue" = round(cox_sage$table_body$p.value, digits = 3))

cox_chap <- coxme(Surv(start_time, end_time, dead) ~ plants_alive + (1|plot), data = survival_density %>% filter(community_type == "chap") %>% 
        filter(dead == 1 |end_date == "2022-11-21") %>% mutate(start_time = 0)) %>% tbl_regression(exp = T)

cox_chap_estimates <- data_frame("group" = "chaparral", 
                                "hazard_ratio" = cox_chap$table_body$estimate, 
                                "lower" = cox_chap$table_body$conf.low, 
                                "upper" = cox_chap$table_body$conf.high,
                                "pvalue" = round(cox_chap$table_body$p.value, digits = 3))
density_estimates <- rbind(cox_all_estimates, cox_sage_estimates, cox_chap_estimates)

<<<<<<< HEAD
figure_2 <- ggplot(density_estimates, aes(x = hazard_ratio, y = group)) +
  geom_point()+
  geom_errorbar(aes(xmin = lower, xmax = upper))+
  geom_vline(xintercept = 1, linetype = "dashed")+
  geom_text(aes(x = 1.05, label = paste("p =", pvalue)))+
  theme_classic() +
  labs(x = "Hazard Ratio",
       y = "") +
  xlim(0.85, 1.1)

ggsave(filename = "figure2.png", plot = figure_2, path = here("figures"), width = 4, height = 4, units = "in")

```


```{r}
cox_enviro_all <- coxme(Surv(start_time, end_time, dead) ~ soil_moisture + par + plants_alive + par:end_time + (1|plot),
              data = survival_environmental) %>% 
  tbl_regression(exp = T)

cox_enviro_all_estimates <- data_frame("group" = "whole plot",
                                         "variable" = cox_enviro_all$table_body$label,
                                         "hazard_ratio" = cox_enviro_all$table_body$estimate,
                                         "lower" = cox_enviro_all$table_body$conf.low,
                                         "upper" = cox_enviro_all$table_body$conf.high,
                                         "pvalue" = round(cox_enviro_all$table_body$p.value, digits = 3)) %>% 
  mutate(variable = case_when(variable == "soil_moisture" ~ "Soil moisture",
                              variable == "plants_alive" ~ "April density",
                              variable == "par * end_time" ~ "PAR * time",
                              variable == "par" ~ "PAR"))


cox_enviro_sage <- coxme(Surv(start_time, end_time, dead) ~ soil_moisture + par + plants_alive + par:end_time + (1|plot), 
                         data = survival_environmental %>% filter(community_type == "sage")) %>% tbl_regression(exp = T)

cox_enviro_sage_estimates <- data_frame("group" = "sage scrub",
                                         "hazard_ratio" = cox_enviro_sage$table_body$estimate,
                                        "variable" = cox_enviro_sage$table_body$label,
                                         "lower" = cox_enviro_sage$table_body$conf.low,
                                         "upper" = cox_enviro_sage$table_body$conf.high,
                                         "pvalue" = round(cox_enviro_sage$table_body$p.value, digits = 3)) %>% 
  mutate(variable = case_when(variable == "soil_moisture" ~ "Soil moisture",
                              variable == "plants_alive" ~ "April density",
                              variable == "par * end_time" ~ "PAR * time",
                              variable == "par" ~ "PAR"))

cox_enviro_chap <- coxme(Surv(start_time, end_time, dead) ~ soil_moisture + par + plants_alive + par:end_time + (1|plot),
                         data = survival_environmental %>% filter(community_type == "chap")) %>% 
  tbl_regression(exp = T)

cox_enviro_chap_estimates <- data_frame("group" = "chaparral",
                                         "hazard_ratio" = cox_enviro_chap$table_body$estimate,
                                        "variable" = cox_enviro_chap$table_body$label,
                                         "lower" = cox_enviro_chap$table_body$conf.low,
                                         "upper" = cox_enviro_chap$table_body$conf.high,
                                         "pvalue" = round(cox_enviro_chap$table_body$p.value, digits = 3)) %>% 
  mutate(variable = case_when(variable == "soil_moisture" ~ "Soil moisture",
                              variable == "plants_alive" ~ "April density",
                              variable == "par * end_time" ~ "PAR * time",
                              variable == "par" ~ "PAR"))

plot_graph <- ggplot(cox_enviro_all_estimates, aes(x = hazard_ratio, y = variable)) +
  geom_point()+
  geom_errorbar(aes(xmin = lower, xmax = upper))+
  geom_vline(xintercept = 1, linetype = "dashed")+
  geom_text(aes(x = 1.5, y = "Soil moisture", label = paste("p =", pvalue[1])))+
  geom_text(aes(x = 1.3, y = "April density", label = "p<0.01"))+
  geom_text(aes(x = 1.3, y = "PAR * time", label = "p<0.01"))+
  geom_text(aes(x = 1.3, y = "PAR", label = "p<0.01"))+
  theme_classic() +
  labs(x = "Hazard Ratio", 
       y = "",
       title = "Whole Plot") +
  theme(plot.title = element_text(hjust = 0.5))

sage_graph <- ggplot(cox_enviro_sage_estimates, aes(x = hazard_ratio, y = variable)) +
  geom_point()+
  geom_errorbar(aes(xmin = lower, xmax = upper))+
  geom_vline(xintercept = 1, linetype = "dashed")+
  geom_text(aes(x = 2.5, y = "Soil moisture", label = paste("p =", pvalue[1])))+
  geom_text(aes(x = 2, y = "April density", label = paste("p =", pvalue[2])))+
  geom_text(aes(x = 2, y = "PAR * time", label = paste("p =", pvalue[3])))+
  geom_text(aes(x = 0.4, y = "PAR", label = "p<0.01"), vjust = 0.5)+
  theme_classic()+
  theme_classic() +
  labs(x = "Hazard Ratio", 
       y = "",
       title = "Sage Scrub") +
  theme(plot.title = element_text(hjust = 0.5))

chap_graph <- ggplot(cox_enviro_chap_estimates, aes(x = hazard_ratio, y = variable)) +
  geom_point()+
  geom_errorbar(aes(xmin = lower, xmax = upper))+
  geom_vline(xintercept = 1, linetype = "dashed")+
  geom_text(aes(x = 1.5, y = "Soil moisture", label = paste("p =", pvalue[1])))+
  geom_text(aes(x = 1.2, y = "April density", label = "p<0.01"))+
  geom_text(aes(x = 1.2, y = "PAR * time", label = paste("p =", pvalue[3])))+
  geom_text(aes(x = 0.75, y = "PAR", label = paste("p =", pvalue[2])))+
  theme_classic()+
  theme_classic() +
  labs(x = "Hazard Ratio", 
       y = "",
       title = "Chaparral") +
  theme(plot.title = element_text(hjust = 0.5))

figure_3 <- plot_graph/sage_graph/chap_graph + plot_annotation(tag_levels = "A")
figure_3

ggsave("figure3.png", figure_3, path = here("figures"), width = 8, height = 8, units = "in")
```

```{r}
cox.zph(coxme(Surv(start_time, end_time, dead) ~ plants_alive*les_1 + (1|plot),
                         data = survival_environmental_traits))
plot(cox.zph(coxme(Surv(start_time, end_time, dead) ~ plants_alive*les_1 + (1|plot),
                         data = survival_environmental_traits)))

cox.zph(coxme(Surv(start_time, end_time, dead) ~ plants_alive*les_2 + (1|plot),
                         data = survival_environmental_traits))
cox.zph(coxme(Surv(start_time, end_time, dead) ~ plants_alive*wood_density + (1|plot),
                         data = survival_environmental_traits))
cox.zph(coxme(Surv(start_time, end_time, dead) ~ plants_alive*wue + (1|plot),
                         data = survival_environmental_traits))
plot(cox.zph(coxme(Surv(start_time, end_time, dead) ~ plants_alive*wue + (1|plot),
                         data = survival_environmental_traits)))

les1_model <- coxme(Surv(start_time, end_time, dead) ~ plants_alive*les_1 + (1|plot),
                         data = survival_environmental_traits) %>% tbl_regression(exp = T)
les2_model <- coxme(Surv(start_time, end_time, dead) ~ plants_alive*les_2 + (1|plot),
                         data = survival_environmental_traits) %>% tbl_regression(exp = T)
wood_density_model <- coxme(Surv(start_time, end_time, dead) ~ plants_alive*wood_density + (1|plot),
                         data = survival_environmental_traits) %>% tbl_regression(exp = T)
wue_model <- coxme(Surv(start_time, end_time, dead) ~ plants_alive*wue + (1|plot),
                         data = survival_environmental_traits) %>% tbl_regression(exp = T)

les1_estimates <- data_frame("hazard_ratio" = les1_model$table_body$estimate,
                             "variable" = les1_model$table_body$label,
                             "lower" = les1_model$table_body$conf.low,
                             "upper" = les1_model$table_body$conf.high,
                             "pvalue" = round(les1_model$table_body$p.value, digits = 3)) %>% 
  mutate(variable = case_when(variable == "plants_alive * les_1" ~ "LES 1 *  \n April density",
                              variable == "plants_alive" ~ "April density",
                              variable == "les_1" ~ "LES 1"))

les2_estimates <- data_frame("hazard_ratio" = les2_model$table_body$estimate,
                             "variable" = les2_model$table_body$label,
                             "lower" = les2_model$table_body$conf.low,
                             "upper" = les2_model$table_body$conf.high,
                             "pvalue" = round(les2_model$table_body$p.value, digits = 3)) %>% 
  mutate(variable = case_when(variable == "plants_alive * les_2" ~ "LES 2 * \n April density",
                              variable == "plants_alive" ~ "April density",
                              variable == "les_2" ~ "LES 2"))

wood_density_estimates <- data_frame("hazard_ratio" = wood_density_model$table_body$estimate,
                             "variable" = wood_density_model$table_body$label,
                             "lower" = wood_density_model$table_body$conf.low,
                             "upper" = wood_density_model$table_body$conf.high,
                             "pvalue" = round(wood_density_model$table_body$p.value, digits = 3)) %>% 
  mutate(variable = case_when(variable == "plants_alive * wood_density" ~ "Wood density * \n April density",
                              variable == "plants_alive" ~ "April density",
                              variable == "wood_density" ~ "Wood density"))

wue_estimates <- data_frame("hazard_ratio" = wue_model$table_body$estimate,
                             "variable" = wue_model$table_body$label,
                             "lower" = wue_model$table_body$conf.low,
                             "upper" = wue_model$table_body$conf.high,
                             "pvalue" = round(wue_model$table_body$p.value, digits = 3)) %>% 
  mutate(variable = case_when(variable == "plants_alive * wue" ~ "Water use efficiency * \n April density",
                              variable == "plants_alive" ~ "April density",
                              variable == "wue" ~ "Water use efficiency"))

les1_graph <- ggplot(les1_estimates, aes(x = hazard_ratio, y = variable)) +
  geom_point()+
  geom_errorbar(aes(xmin = lower, xmax = upper))+
  geom_vline(xintercept = 1, linetype = "dashed")+
  geom_text(aes(x = 0.3, label = "p<0.01"))+
  theme_classic() +
  labs(x = "Hazard Ratio",
       y = "") +
  xlim(0, 3.5)+
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 15))

les2_graph <- ggplot(les2_estimates, aes(x = hazard_ratio, y = variable)) +
  geom_point()+
  geom_errorbar(aes(xmin = lower, xmax = upper))+
  geom_vline(xintercept = 1, linetype = "dashed")+
  geom_text(aes(x = 2, label = paste("p =", pvalue)), vjust = -1)+
  theme_classic() +
  labs(x = "Hazard Ratio",
       y = "") +
  xlim(0, 3)+
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 15))
  

wood_density_graph <- ggplot(wood_density_estimates, aes(x = hazard_ratio, y = variable)) +
  geom_point()+
  geom_errorbar(aes(xmin = lower, xmax = upper))+
  geom_vline(xintercept = 1, linetype = "dashed")+
  geom_text(aes(x = 3, y = "Wood density * \n April density", label = paste("p =", pvalue[1])))+
  geom_text(aes(x = 3, y = "Wood density", label = paste("p =", pvalue[2])), vjust = -1)+
  geom_text(aes(x = 3, y = "April density", label = paste("p > 0.01")))+
  theme_classic() +
  labs(x = "Hazard Ratio",
       y = "") +
  xlim(0, 5.5)+
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 15))

wue_graph <- ggplot(wue_estimates, aes(x = hazard_ratio, y = variable)) +
  geom_point()+
  geom_errorbar(aes(xmin = lower, xmax = upper))+
  geom_vline(xintercept = 1, linetype = "dashed")+
  geom_text(aes(x = 0.7, y = "Water use efficiency", label = "p<0.01"))+
  geom_text(aes(x = 0.7, y = "Water use efficiency * \n April density", label = "p<0.01"))+
  geom_text(aes(x = 0.7, y = "April density", label = "p<0.01"))+
  theme_classic() +
  labs(x = "Hazard Ratio",
       y = "") +
  xlim(0,1.05)+
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 15))

figure_4 <- (les1_graph + les2_graph)/(wood_density_graph + wue_graph) + plot_annotation(tag_levels = "A")

ggsave("figure4.png", figure_4, path = here("figures"), width = 8, height = 8, units = "in")
```

```{r}
par_early <- par %>% 
  filter(date %in% c("2022-02-17", "2022-04-05")) %>% 
  select(plot, date, par)
soil_moisture_early <- soil_moisture %>% 
  filter(date %in% c("2022-02-17", "2022-04-05")) %>% 
  select(plot, date, soil_moisture)

density_early <- par_early %>% 
  inner_join(soil_moisture_early, by = c("plot", "date")) %>% 
  inner_join(survival_sum, by = "plot")

summary(glm(plants_alive~par, data = density_early %>% filter(date == "2022-02-17")))
summary(glm(plants_alive~par, data = density_early %>% filter(date == "2022-04-05")))

summary(glm(plants_alive~soil_moisture, data = density_early %>% filter(date == "2022-02-17")))
summary(glm(plants_alive~soil_moisture, data = density_early %>% filter(date == "2022-04-05")))

summary(glm(plants_alive~par + soil_moisture, data = density_early))
summary(glm(plants_alive~par + soil_moisture, data = density_early %>% filter(date == "2022-04-05")))

ggplot(density_early %>% filter(date == "2022-02-17"), aes(x = soil_moisture, y = plants_alive))+
=======
ggplot(density_estimates, aes(x = hazard_ratio, y = group)) +
>>>>>>> 8782b0b8e2a1e7c27dac0a6767089b0791bd066f
  geom_point()+
  geom_errorbar(aes(xmin = lower, xmax = upper))+
  geom_vline(xintercept = 1, linetype = "dashed")+
  geom_text(aes(x = 1.023, label = paste("p =", pvalue)))+
  theme_classic()

```
<<<<<<< HEAD
```{r}

=======


```{r}
cox_enviro_all <- coxme(Surv(start_time, end_time, dead) ~ soil_moisture + par + plants_alive + par:end_time + (1|plot),
              data = survival_environmental) %>% 
  tbl_regression(exp = T)

cox_enviro_all_estimates <- data_frame("group" = "whole plot",
                                         "variable" = cox_enviro_all$table_body$label,
                                         "hazard_ratio" = cox_enviro_all$table_body$estimate,
                                         "lower" = cox_enviro_all$table_body$conf.low,
                                         "upper" = cox_enviro_all$table_body$conf.high,
                                         "pvalue" = round(cox_enviro_all$table_body$p.value, digits = 3))


cox_enviro_sage <- coxme(Surv(start_time, end_time, dead) ~ soil_moisture + par + plants_alive + par:end_time + (1|plot), 
                         data = survival_environmental %>% filter(community_type == "sage")) %>% tbl_regression(exp = T)

cox_enviro_sage_estimates <- data_frame("group" = "sage scrub",
                                         "hazard_ratio" = cox_enviro_sage$table_body$estimate,
                                        "variable" = cox_enviro_sage$table_body$label,
                                         "lower" = cox_enviro_sage$table_body$conf.low,
                                         "upper" = cox_enviro_sage$table_body$conf.high,
                                         "pvalue" = round(cox_enviro_sage$table_body$p.value, digits = 3))

cox_enviro_chap <- coxme(Surv(start_time, end_time, dead) ~ soil_moisture + par + plants_alive + par:end_time + (1|plot),
                         data = survival_environmental %>% filter(community_type == "chap")) %>% 
  tbl_regression(exp = T)

cox_enviro_chap_estimates <- data_frame("group" = "chaparral",
                                         "hazard_ratio" = cox_enviro_chap$table_body$estimate,
                                        "variable" = cox_enviro_chap$table_body$label,
                                         "lower" = cox_enviro_chap$table_body$conf.low,
                                         "upper" = cox_enviro_chap$table_body$conf.high,
                                         "pvalue" = round(cox_enviro_chap$table_body$p.value, digits = 3))

plot_graph <- ggplot(cox_enviro_all_estimates, aes(x = hazard_ratio, y = variable)) +
  geom_point()+
  geom_errorbar(aes(xmin = lower, xmax = upper))+
  geom_vline(xintercept = 1, linetype = "dashed")+
  geom_text(aes(x = 0, label = paste("p =", pvalue)))+
  theme_classic()

sage_graph <- ggplot(cox_enviro_sage_estimates, aes(x = hazard_ratio, y = variable)) +
  geom_point()+
  geom_errorbar(aes(xmin = lower, xmax = upper))+
  geom_vline(xintercept = 1, linetype = "dashed")+
  geom_text(aes(x = 0, label = paste("p =", pvalue)))+
  theme_classic()

chap_graph <- ggplot(cox_enviro_chap_estimates, aes(x = hazard_ratio, y = variable)) +
  geom_point()+
  geom_errorbar(aes(xmin = lower, xmax = upper))+
  geom_vline(xintercept = 1, linetype = "dashed")+
  geom_text(aes(x = 0, label = paste("p =", pvalue)))+
  theme_classic()

figure_2 <- plot_graph/sage_graph/chap_graph + plot_annotation(tag_levels = "A")
figure_2
>>>>>>> 8782b0b8e2a1e7c27dac0a6767089b0791bd066f
```

```{r}
cox.zph(coxme(Surv(start_time, end_time, dead) ~ plants_alive*les_1 + (1|plot),
                         data = survival_environmental_traits))
plot(cox.zph(coxme(Surv(start_time, end_time, dead) ~ plants_alive*les_1 + (1|plot),
                         data = survival_environmental_traits)))

cox.zph(coxme(Surv(start_time, end_time, dead) ~ plants_alive*les_2 + (1|plot),
                         data = survival_environmental_traits))
cox.zph(coxme(Surv(start_time, end_time, dead) ~ plants_alive*wood_density + (1|plot),
                         data = survival_environmental_traits))
cox.zph(coxme(Surv(start_time, end_time, dead) ~ plants_alive*wue + (1|plot),
                         data = survival_environmental_traits))
plot(cox.zph(coxme(Surv(start_time, end_time, dead) ~ plants_alive*wue + (1|plot),
                         data = survival_environmental_traits)))

les1_model <- coxme(Surv(start_time, end_time, dead) ~ plants_alive*les_1 + (1|plot),
                         data = survival_environmental_traits) %>% tbl_regression(exp = T)
les2_model <- coxme(Surv(start_time, end_time, dead) ~ plants_alive*les_2 + (1|plot),
                         data = survival_environmental_traits) %>% tbl_regression(exp = T)
wood_density_model <- coxme(Surv(start_time, end_time, dead) ~ plants_alive*wood_density + (1|plot),
                         data = survival_environmental_traits) %>% tbl_regression(exp = T)
wue_model <- coxme(Surv(start_time, end_time, dead) ~ plants_alive*wue + (1|plot),
                         data = survival_environmental_traits) %>% tbl_regression(exp = T)

les1_estimates <- data_frame("hazard_ratio" = les1_model$table_body$estimate,
                             "variable" = les1_model$table_body$label,
                             "lower" = les1_model$table_body$conf.low,
                             "upper" = les1_model$table_body$conf.high,
                             "pvalue" = round(les1_model$table_body$p.value, digits = 3))

les2_estimates <- data_frame("hazard_ratio" = les2_model$table_body$estimate,
                             "variable" = les2_model$table_body$label,
                             "lower" = les2_model$table_body$conf.low,
                             "upper" = les2_model$table_body$conf.high,
                             "pvalue" = round(les2_model$table_body$p.value, digits = 3))

wood_density_estimates <- data_frame("hazard_ratio" = wood_density_model$table_body$estimate,
                             "variable" = wood_density_model$table_body$label,
                             "lower" = wood_density_model$table_body$conf.low,
                             "upper" = wood_density_model$table_body$conf.high,
                             "pvalue" = round(wood_density_model$table_body$p.value, digits = 3))

wue_estimates <- data_frame("hazard_ratio" = wue_model$table_body$estimate,
                             "variable" = wue_model$table_body$label,
                             "lower" = wue_model$table_body$conf.low,
                             "upper" = wue_model$table_body$conf.high,
                             "pvalue" = round(wue_model$table_body$p.value, digits = 3))

les1_graph <- ggplot(les1_estimates, aes(x = hazard_ratio, y = variable)) +
  geom_point()+
  geom_errorbar(aes(xmin = lower, xmax = upper))+
  geom_vline(xintercept = 1, linetype = "dashed")+
  geom_text(aes(x = 0, label = paste("p =", pvalue)))+
  theme_classic()
les2_graph <- ggplot(les2_estimates, aes(x = hazard_ratio, y = variable)) +
  geom_point()+
  geom_errorbar(aes(xmin = lower, xmax = upper))+
  geom_vline(xintercept = 1, linetype = "dashed")+
  geom_text(aes(x = 0, label = paste("p =", pvalue)))+
  theme_classic()
wood_density_graph <- ggplot(wood_density_estimates, aes(x = hazard_ratio, y = variable)) +
  geom_point()+
  geom_errorbar(aes(xmin = lower, xmax = upper))+
  geom_vline(xintercept = 1, linetype = "dashed")+
  geom_text(aes(x = 0, label = paste("p =", pvalue)))+
  theme_classic()
wue_graph <- ggplot(wue_estimates, aes(x = hazard_ratio, y = variable)) +
  geom_point()+
  geom_errorbar(aes(xmin = lower, xmax = upper))+
  geom_vline(xintercept = 1, linetype = "dashed")+
  geom_text(aes(x = 0, label = paste("p =", pvalue)))+
  theme_classic()

figure_3 <- (les1_graph + les2_graph)/(wood_density_graph + wue_graph)
figure_3

```


