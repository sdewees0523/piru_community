---
title: "Untitled"
output: html_document
date: "2023-03-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(survival)
library(lubridate)
library(ggsurvfit)
library(gtsummary)
library(survminer)
library(ggfortify)
```

```{r}
survival_data <- read.csv(here("data", "clean_data", "kaplan_survival_data.csv")) %>% 
  select(!X) %>% 
  mutate(month = month(start_date))

survival_sum <- survival_data %>% 
  filter(species %in% c("sale", "saap", "same", "enca", "arca", "erfa")) %>% 
  mutate(alive = case_when(dead == 0 ~ 1,
                           dead == 1 ~ 0)) %>% 
  group_by(plot, end_date) %>% 
  reframe(plants_alive = sum(alive)) %>% 
  rename(start_date = end_date) 

par <- read.csv(here("data", "clean_data", "par_clean.csv")) %>% 
  select(!X) %>% 
  mutate(month = month(date))

soil_moisture <- read.csv(here("data", "clean_data", "soil_moisture_clean.csv")) %>% 
  select(!X) %>% 
  mutate(month = month(date))

survival_environmental <- survival_data %>% 
  inner_join(par, by = c("plot", "month")) %>% 
  inner_join(soil_moisture, by = c("plot", "month"))
  #group_by(month) %>% 
  #mutate(par_plot = scale(par_plot),
  #       soil_moisture = scale(soil_moisture)) %>% 
  #ungroup() %>% 
  mutate(community = as.factor(community)) %>% 
  left_join(survival_sum, by = c("plot", "start_date")) %>% 
  mutate(plants_alive = case_when(community %in% c(1,2) & start_time == 0 ~ 54,
                                  TRUE ~ plants_alive),
         plants_alive = replace_na(plants_alive, 0))

survival_environmental$community <- factor(survival_environmental$community, levels = c(3,2,1))

survival_environmental_chap <- survival_environmental %>%  
  filter(species %in% c("rhov", "adfa", "mala", "cecu", "ceol", "rhil", "hear")) %>% 
  mutate(chap_type = case_when(species %in% c("rhov", "mala", "adfa") ~ "facultive",
                               species %in% c("cecu", "ceol", "rhil", "hear") ~ "obligate"))

```

```{r}
autoplot(survfit(Surv(start_time, end_time, dead) ~ community + community_type, id = unique_id, data = survival_data))

autoplot(survfit(Surv(start_time, end_time, dead) ~ community + chap_type, id = unique_id, data = survival_environmental_chap))
```

```{r}
coxph(Surv(start_time, end_time, dead) ~ community, id = unique_id, data = survival_environmental_chap %>%  filter(chap_type == "facultive"))
coxph(Surv(start_time, end_time, dead) ~ community, id = unique_id, data = survival_environmental_chap %>%  filter(chap_type == "obligate"))

coxph(Surv(start_time, end_time, dead) ~ pspline(plants_alive, df = 3), id = unique_id, data = survival_environmental_chap) %>% tbl_regression(exp = T)
coxph(Surv(start_time, end_time, dead) ~ plants_alive, id = unique_id, data = survival_environmental_chap %>% filter(community %in% c(1,2))) %>%  tbl_regression(exp = T)

facilitation_model <- coxph(Surv(start_time, end_time, dead) ~ plants_alive, df = 3) + chap_type, id = unique_id, data = survival_environmental_chap %>% filter(community %in% c(1,2)))
coxph(Surv(start_time, end_time, dead) ~ plants_alive + chap_type, id = unique_id, data = survival_environmental_chap %>% filter(community %in% c(1,2))) %>%  tbl_regression(exp = T)

facilitation_data <- expand.grid(plants_alive = seq(from = 0, to = 54, by = 1),
                                 chap_type = c("obligate", "facultive")) %>% 
  mutate(start_time = 0, 
         end_time = 292,
         dead = 0) %>% 
  mutate(surv_prob = exp(-predict(facilitation_model, newdata = ., type = "expected")) * 100,
         interval = exp(-predict(facilitation_model, newdata = ., type = "risk", se.fit = T, interval = "confidence")[[2]]),
         upper = surv_prob + interval,
         lower = surv_prob - interval)

ggplot(facilitation_data, aes(x = plants_alive, y = surv_prob, col = chap_type))+
  geom_line()+
  geom_ribbon(aes(ymin =lower, ymax = upper), alpha = 0.5)+
  theme_classic()+
  ylim(0,100)
```
```{r}
summary(glm(par_plot~plants_alive, family = Gamma, data = survival_environmental %>% filter(community %in% c(1,2))))
summary(glm(soil_moisture~plants_alive + (1|start_time), data = survival_environmental%>% filter(community %in% c(1,2))))

ggplot(survival_environmental%>% filter(community %in% c(1,2)), aes(x = plants_alive, y = par_plot))+
  geom_point(aes(col = start_time))+
  geom_smooth(method = "glm",
              method.args ="Gamma")+
  theme_classic()

ggplot(survival_environmental%>% filter(community %in% c(1,2)), aes(x = plants_alive, y = soil_moisture, col = as.factor(start_time)))+
  geom_point()+
  geom_smooth(method = "glm")+
  theme_classic()
```
```{r}
cox.zph(coxph(Surv(start_time, end_time, dead) ~ soil_moisture + par_plot, id = unique_id, data = survival_environmental_chap))
plot(cox.zph(coxph(Surv(start_time, end_time, dead) ~ soil_moisture + par_plot, id = unique_id, data = survival_environmental_chap)))

coxph(Surv(start_time, end_time, dead) ~ soil_moisture + par_plot, id = unique_id, data = survival_environmental_chap) %>% tbl_regression(exp = T)

cox.zph(coxph(Surv(start_time, end_time, dead) ~ soil_moisture + par_plot + plants_alive, id = unique_id, data = survival_environmental_chap))
plot(cox.zph(coxph(Surv(start_time, end_time, dead) ~ soil_moisture + par_plot + plants_alive, id = unique_id, data = survival_environmental_chap)))

summer_enviro_model <- coxph(Surv(start_time, end_time, dead) ~ par_plot + soil_moisture + plants_alive + community, id = unique_id, data = survival_environmental_chap)
```

```{r}
summer_enviro_data_soil_moisture <- data_frame("soil_moisture" = seq(from = min(survival_environmental_chap$soil_moisture, na.rm = T), to = max(survival_environmental_chap$soil_moisture, na.rm = T), by = 0.5)) %>% 
  mutate(start_time = 0, 
         end_time = 292,
         dead = 0,
         par_plot = median(survival_environmental_chap$par_plot, na.rm = T),
         plants_alive = median(survival_environmental_chap$plants_alive),
         community = "2") %>% 
  mutate(prop_alive = predict(summer_enviro_model, newdata = ., type = "surv") *100,
         interval = predict(summer_enviro_model, newdata = ., type = "surv", se.fit = T, interval = "confidence")[[2]]*100,
         upper = prop_alive + interval,
         lower = prop_alive - interval)

summer_enviro_data_par <- data_frame("par_plot" = seq(from = min(survival_environmental_chap$par_plot, na.rm = T), to = max(survival_environmental_chap$par_plot, na.rm = T), by = 0.1)) %>% 
  mutate(start_time = 0, 
         end_time = 292,
         dead = 0,
         soil_moisture = median(survival_environmental_chap$soil_moisture, na.rm = T),
         plants_alive = median(survival_environmental_chap$plants_alive),
         community = "2") %>% 
  mutate(prop_alive = predict(summer_enviro_model, newdata = ., type = "surv") *100,
         interval = predict(summer_enviro_model, newdata = ., type = "surv", se.fit = T, interval = "confidence")[[2]]*100,
         upper = prop_alive + interval,
         lower = prop_alive - interval)

summer_enviro_data_plants_alive <- expand.grid("plants_alive" = seq(from = 0, to = 54, by = 1),
                                               community = c(1,2,3)) %>% 
  mutate(start_time = 0, 
         end_time = 292,
         dead = 0,
         par_plot = median(survival_environmental_chap$par_plot, na.rm = T),
         soil_moisture = median(survival_environmental_chap$soil_moisture, na.rm = T),
         community = as.factor(community)) %>% 
  mutate(prop_alive = predict(summer_enviro_model, newdata = ., type = "surv") *100,
         interval = predict(summer_enviro_model, newdata = ., type = "surv", se.fit = T, interval = "confidence")[[2]]*100,
         upper = prop_alive + interval,
         lower = prop_alive - interval)

ggplot()+
  geom_line(data = summer_enviro_data_soil_moisture, aes(x = soil_moisture, y = prop_alive), col = "blue")+
  geom_ribbon(data = summer_enviro_data_soil_moisture, aes(x = soil_moisture, ymin = lower, ymax = upper), alpha = 0.5, col = "blue")+
  theme_classic()+
  ylim(0, 100)

ggplot(summer_enviro_data_par, aes(x = par_plot, y = prop_alive))+
  geom_line()+
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.5)+
  theme_classic()+
  ylim(0, 100)

ggplot(summer_enviro_data_plants_alive, aes(x = plants_alive, y = prop_alive, col = community))+
  geom_line()+
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.5)+
  theme_classic()+
  ylim(0, 100)
```



