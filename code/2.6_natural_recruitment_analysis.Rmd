---
title: "Untitled"
output: html_document
date: "2024-02-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(lubridate)
library(patchwork)
library(lme4)
library(lmerTest)
```

```{r}
percent_cover <- read.csv(here("data", "clean_data", "percent_cover_clean.csv")) %>% 
  filter(!species %in% c("Chaparral", "Sage")) %>% 
  mutate(group = case_when(group %in% c("all avena", "non native herb") ~ "nonnative",
                           group %in% c("chaparral", "native herb", "sage", "") ~ "native",
                           T ~ group),
         date = ymd(date)) %>% 
  select(!species & !X) %>% 
  group_by(plot, group, date) %>% 
  reframe(percent_cover = sum(percent_cover)) %>%
  mutate(month = month(date)) %>% 
  filter(month != 3) %>% 
  pivot_wider(names_from = group, values_from = percent_cover) %>% 
  drop_na()
  
  
natural_recruitment_species <- read.csv(here("data", "raw_data", "natural_recruitment.csv")) %>% 
  mutate(date = mdy(date)) %>% 
  left_join(percent_cover, by = c("plot", "date"))

natural_recruitment <- natural_recruitment_species%>% 
  group_by(plot, date) %>% 
  reframe(present = sum(present)) %>% 
  mutate(present = case_when(present > 0 ~ 1,
                             T ~ present),
         present = as.factor(present)) %>% 
  left_join(percent_cover, by = c("plot", "date"))

par <- read.csv(here("data", "clean_data", "par_clean.csv")) %>%  
  group_by(plot, date) %>% 
  reframe(par = mean(par, na.rm = T)) %>% 
  mutate(date = ymd(date),
         month = month(date),
         year = year(date)) %>% 
  filter(date == "2023-09-25") %>% 
  group_by(plot) %>% 
  reframe(par = mean(par))

soil_moisture <- read.csv(here("data", "clean_data", "soil_moisture_clean.csv")) %>% 
  filter(date == "2023-09-25") %>% 
  group_by(plot) %>% 
  reframe(soil_moisture = mean(soil_moisture))

natural_recruitment_enviro <- natural_recruitment_species %>% 
  left_join(par, by = "plot") %>% 
  left_join(soil_moisture, by = "plot")

summary(glm(nonnative ~ native, family = Gamma, data = percent_cover))

figure_5 <- ggplot(percent_cover, aes(x = native, y = nonnative)) +
  geom_point(alpha = 0.5) +
  geom_text(aes(x = 90, y = 80, label = "p < 0.01"))+
  geom_smooth(method = glm, 
              method.args = list("Gamma")) +
  theme_classic()+ 
  ylim(0,100) +
  labs(x = "Percent native cover",
       y = "Percent nonnative cover")

ggsave("figure5.png", figure_5, path = here("figures"), width = 4, height = 4, units = "in")
```

```{r}

native_model <- glmer(present~native + (1|species), family = binomial, data = natural_recruitment_species)
summary(native_model)
nonnative_model <- glmer(present~nonnative + (1|species), family = binomial, data = natural_recruitment_species)
summary(nonnative_model)

natural_recruitment_models <- natural_recruitment_species %>% 
  mutate(native_model = predict(native_model, type = "response"),
         nonnative_model = predict(nonnative_model, type = "response"))

summary(glm(present~native, family = "binomial", data = natural_recruitment))
summary(glm(present~nonnative, family = "binomial", data = natural_recruitment))

figure_6a <- ggplot(natural_recruitment_models, aes(x = native, y = present, col = species, group = species)) +
  geom_point(alpha = 0.25)+
  geom_text(aes(x = 5, y = 0.9, label = "p < 0.01"), col = "black")+
  geom_line(aes(y= native_model)) +
  theme_classic() +
  labs(x = "Percent native cover",
       y = "Natural recruitment")


figure_6b <- ggplot(natural_recruitment_models, aes(x = nonnative, y = present, col = species, group = species)) +
  geom_point(alpha = 0.25)+
  geom_text(aes(x = 10, y = 0.9, label = "p = 0.024"))+
  geom_line(aes(y = nonnative_model)) +
  theme_classic() +
  labs(x = "Percent nonnative cover",
       y = "Natural recruitment")
```

```{r}
par_model <- glmer(present~par + (1|species), family = "binomial", data = natural_recruitment_enviro)
summary(par_model)
soil_moisture_model <- glmer(present~soil_moisture + (1|species) , family = "binomial", data = natural_recruitment_enviro)
summary(soil_moisture_model)

natural_recruitment_enviro_models <- natural_recruitment_enviro %>% 
  mutate(par_model = predict(par_model, type = "response"),
         soil_model = predict(soil_moisture_model, type = "response"))


figure_6c <- ggplot(natural_recruitment_enviro_models, aes(x = par, y = present, col = species, group = species)) +
  geom_point(alpha = 0.25)+
  geom_line(aes(y = par_model)) +
  geom_text(aes(x = 0.7, y = 0.9, label = "p = 0.032")) +
  theme_classic() +
  labs(x = "PAR", 
       y = "Natural recruitment")

figure_6d <- ggplot(natural_recruitment_enviro_models, aes(x = soil_moisture, y = present, col = species, group = species)) +
  geom_point(alpha = 0.25)+
  geom_smooth(aes(y = soil_model)) +
  geom_text(aes(x = 8.5, y = 0.9, label = "p = 0.11")) +
  theme_classic() +
  labs(x = "Soil Moisture (%)", 
       y = "Natural recruitment")

figure_6 <- (figure_6a + figure_6b)/(figure_6c + figure_6d) + plot_annotation(tag_levels = "A")
ggsave("figure_6.png", 
       figure_6,
       path = here("figures"),
       width = 7, 
       height = 8,
       units = "in")

```

```{r}
temperature <- read.csv(here("data", "clean_data", "temperature.csv")) %>% 
  dplyr::select(!X) %>% 
  mutate(month = month(date))

vpd <- read.csv(here("data", "clean_data", "vpd.csv")) %>% 
  dplyr::select(!X) %>% 
  mutate(month = month(date))

max_temperature <- temperature %>% 
  group_by(plot, rep, date) %>% 
  reframe(temperature = max(temperature)) %>% 
  mutate(month = month(date)) %>% 
  filter(month == 9) %>% 
  group_by(plot) %>% 
  reframe(temperature = mean(temperature))

max_vpd <- vpd %>% 
  group_by(plot, rep, date) %>% 
  reframe(vpd = max(vpd)) %>% 
  mutate(month = month(date)) %>% 
  filter(month == 9) %>% 
  group_by(plot) %>% 
  reframe(vpd = mean(vpd))

natural_recruitment_ibutton <- natural_recruitment_species %>% 
  left_join(max_temperature, by = "plot") %>% 
  left_join(max_vpd, by = "plot")

summary(glmer(present~temperature + (1|species), family = "binomial", data = natural_recruitment_ibutton))
summary(glmer(present~vpd + (1|species), family = "binomial", data = natural_recruitment_ibutton))

```

