---
title: "piru community plots"
author: "Shane Dewees"
date: "3/30/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(lubridate)
library(broom)
library(gmodels)
library(DescTools)
library(gmodels)
library(readxl)
library(janitor)
```


Reading in data
```{r}
community_types <- read.csv(here("data", "community_types.csv"))
environmental_data <- read.csv(here("data", "par_soil_moisture.csv")) %>% 
  select(!community) %>% 
  full_join(community_types, join_by = "plot") %>% 
  mutate(date = mdy(date)) %>% 
  mutate(community = as.character(community))

#Coerced community to character so ggplot recognizes as discrete variable

survival_data <- read.csv(here("data", "survival.csv")) %>% 
  distinct() %>% 
  select(1:6)%>% 
  mutate(species = case_when(species == "ADFA" ~ "adfa", 
                             species == "ARCA" ~ "arca",
                             species %in% c("E0CA", "E0FA", "ENCA") ~ "enca",
                             species %in% c("ERFA", "ERCA") ~ "erfa",
                             species == "HEAR" ~ "hear",
                             species %in% c("MALA", "AMALA", "MALA?", "MELA") ~ "mala",
                             species %in% c("RHOU", "RHOV", "RHOB") ~ "rhov",
                             species == "SAAP" ~ "saap",
                             species %in% c("SALE", "SALEU")~ "sale",
                             species %in% c("SAME", "SAAME") ~ "same",
                             species %in% c("CECU", "GECU") ~ "cecu",
                             species %in% c("CEOL", "EOL", " CEOL") ~ "ceol",
                             species %in% c("RHIL", "RAIL") ~ "rhil",
                             TRUE ~ species),
         alive = replace_na(alive, 0)) %>%
  group_by(plot, date, species) %>% 
  mutate(number_alive = sum(alive, na.rm = TRUE)) %>% 
  ungroup() %>% 
  select(!id & !alive & !X0otes) %>% 
  distinct() %>% 
  filter(species %in% c("sale", "saap", "arca", "erfa", "same", "enca", "adfa", "rhov", "mala", "ceol", "cecu", "rhil", "hear")) %>% 
  right_join(community_types, by = "plot") %>% 
  mutate(number_planted = case_when(community %in% c(1,2) & species == "sale" ~ 10,
                                    community %in% c(1,2) & species == "saap" ~ 10,
                                    community %in% c(1,2) & species == "arca" ~ 10,
                                    community %in% c(1,2) & species == "erfa" ~ 7,
                                    community %in% c(1,2) & species == "same" ~ 7,
                                    community %in% c(1,2) & species == "enca" ~ 10,
                                    community == 1 & species == "ceol" ~ 7,
                                    community == 1 & species == "cecu" ~ 5,
                                    community == 1 & species == "hear" ~ 7,
                                    community == 1 & species == "rhil" ~ 7,
                                    community == 2 & species == "adfa" ~ 9,
                                    community == 2 & species == "rhov" ~ 9,
                                    community == 2 & species == "mala" ~ 8,
                                    community == 3 & species == "ceol" ~ 13,
                                    community == 3 & species == "cecu" ~ 5,
                                    community == 3 & species == "hear" ~ 12,
                                    community == 3 & species == "rhil" ~ 12,
                                    community == 3 & species == "adfa" ~ 13,
                                    community == 3 & species == "rhov" ~ 13,
                                    community == 3 & species == "mala" ~ 12),
         number_planted = case_when(as.numeric(number_alive) > as.numeric(number_planted) ~ as.numeric(number_alive),
                                    as.numeric(number_alive) <= as.numeric(number_planted) ~ as.numeric(number_planted)),
         percent_alive = number_alive/number_planted * 100,
         date = mdy(date),
         month = month(date, label = TRUE),
         community = case_when(community == 1 ~ "sage_obligate_seeder/resprouter",
                               community == 2 ~ "sage_facultative_resprouter",
                               community == 3 ~ "chaparral_only")) %>% 
  drop_na(number_planted)

survival_summary <- survival_data %>% 
  group_by(community, month, species) %>% 
  summarise(mean_survival = mean(percent_alive, na.rm = TRUE),
            ci_lower = ci(percent_alive, na.rm =TRUE)[2],
            ci_upper = ci(percent_alive, na.rm = TRUE)[3])
  


ggplot(survival_summary, aes(x = month, y = mean_survival, col= as.factor(community)), size = 5) +
  geom_point()+
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.3 )+
  facet_wrap(~species) +
  theme_classic() +
  theme(text = element_text(size = 10))+
  labs(y = "Percent survival",
       color = "community type")
```

```{r}
community_survival <- survival_data %>% 
  mutate(functional_group = case_when(species %in% c("sale", "saap", "arca", "erfa", "same", "enca")~ "sage_scrub",
                                      species %in% c("adfa", "rhov", "mala", "ceol", "cecu", "rhil", "hear")~ "chaparral")) %>% 
  group_by(community, month, functional_group) %>% 
  summarise(mean_survival = mean(percent_alive, na.rm = TRUE),
            ci_lower = ci(percent_alive, na.rm =TRUE)[2],
            ci_upper = ci(percent_alive, na.rm = TRUE)[3])
  
ggplot(community_survival, aes(x = as.factor(community), y = mean_survival, col= functional_group), alpha = 0.5) +
  geom_point()+
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.3 )+
  facet_wrap(~month) +
  theme_classic() +
  theme(text = element_text(size = 10),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  ylim(0,100)+
  labs(x = "community type",
       y = "Percent survival")


```

Caluclate % of ambient par in plots
```{r}
environmental_data <- environmental_data %>% 
  mutate(par_prop = 100 - (par_plot / par_ambient) * 100,
         community = as.factor(community),
         date = case_when(is.na(date) == TRUE ~ ymd("2022-07-15"),
                          TRUE ~ date))
```


Anova and Tukeys test to test for significance of soil moisture and %ambient par between communities
```{r}
par_data_stats <- environmental_data %>% 
  select(!plot & !par_ambient & !par_plot & ! probe_length) %>% 
  nest(data = c(community, par_prop, soil_moisture)) %>% 
  mutate(par_ttest = map(data, ~tidy(TukeyHSD(aov(par_prop~community, .x)))))

soil_moisture_stats <- environmental_data %>% 
  select(!plot & !par_ambient & !par_plot & ! probe_length) %>% 
  filter(date != "2022-08-05") %>% 
  nest(data = c(community, par_prop, soil_moisture)) %>% 
  mutate(soil_moisture_ttest = map(data, ~tidy(TukeyHSD(aov(soil_moisture~community, .x)))))

par_data_mean <- environmental_data %>% 
  select(!plot & !par_ambient & !par_plot & ! probe_length & !soil_moisture) %>% 
  group_by(community, date) %>% 
  summarise(mean = ci(par_prop, na.rm = TRUE)[1],
            lower = ci(par_prop, na.rm = TRUE)[2],
            upper = ci(par_prop, na.rm = TRUE)[3])
moisture_data_mean <- environmental_data %>% 
  filter(date != "2022-08-05") %>% 
  select(!plot & !par_ambient & !par_plot & ! probe_length & !par_prop) %>% 
  group_by(community, date) %>% 
  summarise(mean = ci(soil_moisture, na.rm = TRUE)[1],
            lower = ci(soil_moisture, na.rm = TRUE)[2],
            upper = ci(soil_moisture, na.rm = TRUE)[3])
  
```

Make some ggplots of %ambient par and soil moisture to visualize data
```{r}
#Scatter plot of %ambient par vs soil moisture with color indicating community
ggplot(data = environmental_data) +
  geom_point(mapping = aes(x = par_prop, y = soil_moisture, color = community), alpha = .5) +
  geom_smooth(mapping = aes(x = par_prop, y = soil_moisture, color = community, fill = community), method = "lm", formula = y ~ x, alpha = .05) +
  facet_wrap(~date)+
  theme_classic() +
  labs(caption = "Figure 1: Percent of ambient par blocked by plants versus soil moisture for three community types",
       x = "Percent of Ambient Par Blocked",
       y = "Soil Moisture",
       color = "Community Type:",
       fill = "") +
  guides(fill = FALSE) +
  theme(plot.caption = element_text(face = "bold", size = 11, hjust = 0),
        legend.position = "top",
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 7))

#Jitter plot for soil moisture
ggplot() +
  geom_jitter(data = environmental_data %>% filter(date != "2022-08-05"),mapping = aes(x = community, y = soil_moisture), width = .2, alpha = .25, color = "blue") +
  geom_point(data = moisture_data_mean, aes(x = community, y = mean), size = 2, color = "blue") +
  geom_errorbar(data = moisture_data_mean, aes(x = community, ymin = lower, ymax = upper), color = "blue", width = 0.5)+
  facet_wrap(~date) +
  theme_classic() +
  labs(x = "Community Type",
       y = "Soil Moisture") +
  theme(plot.caption = element_text(face = "bold", size = 11, hjust = 0),
        legend.position = "top",
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 7))

#Jitter plot for par_prop
ggplot() +
  geom_jitter(data = environmental_data, mapping = aes(x = community, y = par_prop), width = .2, alpha = .25, color = "orange") +
  geom_point(data = par_data_mean, aes(x= community, y = mean), size = 2, color = "orange")+
  geom_errorbar(data = par_data_mean, aes(x = community, ymin = lower, ymax = upper), color = "orange", width = 0.5)+
  facet_wrap(~date) +
  theme_classic() +
  labs(caption = "Figure 3: Proportion of ambient PAR blocked across community types.",
       x = "Community Type",
       y = "Proportion of PAR Blocked") +
  theme(plot.caption = element_text(face = "bold", size = 11, hjust = 0),
        legend.position = "top",
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 7))+
  ylim(-5,100)
```

## Graphs soil moisture and PAR with date as the x-axis and colored by community. Graphing mean and 95% confidence intervals. 

```{r}
soil_moisture_mean <- environmental_data %>% 
  group_by(community, date) %>% 
  summarise(mean = ci(soil_moisture)[1],
            lowCI = ci(soil_moisture)[2],
            highCI = ci(soil_moisture)[3]) 

ggplot(soil_moisture_mean, aes(date, mean, color = community))+
  geom_point()+
  geom_errorbar(aes(ymin=lowCI, ymax=highCI)) +
  labs(x = "date",
       y = "soil moisture (%)")



par_plot_mean <- environmental_data %>% 
  group_by(community, date) %>% 
  summarise(mean = ci(par_plot)[1],
            lowCI = ci(par_plot)[2],
            highCI = ci(par_plot)[3]) 

ggplot(par_plot_mean, aes(date, mean, color = community))+
  geom_point()+
  geom_errorbar(aes(ymin=lowCI, ymax=highCI)) +
  labs(x = "date",
       y = "par")
```


## lm(percent_survival~soil_moisture + par + species)

```{r}
survival_environmental_data <- survival_data %>% 
  inner_join(environmental_data, survival_data, by = c("plot", "date"))   

summary(lm(percent_alive ~ soil_moisture + par_prop + species, survival_environmental_data))
```

## lm(percent_survival~soil_moisture) for each species

```{r}
summary(lm(percent_alive ~ soil_moisture * species, data = survival_environmental_data))
```

## lm(perecent_survival~par) for each species

```{r}
summary(lm(percent_alive ~ par_prop * species, data = survival_environmental_data))
```

## ggplot survival and each environmental measurement + geom_smooth(type = "lm")
## repeat all of the above but with height. 

```{r}
environmental_plot <- environmental_data %>% 
  group_by(plot, date) %>% 
  summarize(mean_soil_moisture = mean(soil_moisture, na.rm = TRUE),
            mean_par = mean(par_prop, na.rm = TRUE)) %>% 
  mutate(month = month(date, label = TRUE))

survival_environmental <- survival_data %>% 
  group_by(plot, date) %>% 
  summarise(survival = (sum(number_alive, na.rm = TRUE)/80)*100) %>% 
  ungroup() %>% 
  mutate(month = month(date, label = TRUE)) %>% 
  left_join(environmental_plot, by = c("plot", "month"))

ggplot(survival_environmental, aes(x = mean_soil_moisture, y = survival))+
  geom_point()+
  geom_smooth(method = "lm")+
  facet_wrap(~month)+
  theme_classic()
ggplot(survival_environmental, aes(x = mean_par, y = survival))+
  geom_point()+
  geom_smooth(method = "lm")+
  facet_wrap(~month)+
  theme_classic()

summary(lm(survival~mean_soil_moisture, data = survival_environmental %>% filter(month == "Apr")))
summary(lm(survival~mean_soil_moisture, data = survival_environmental %>% filter(month == "Jun")))

summary(lm(survival~mean_par, data = survival_environmental %>% filter(month == "Apr")))
summary(lm(survival~mean_par, data = survival_environmental %>% filter(month == "Jun")))
summary(lm(survival~mean_par, data = survival_environmental %>% filter(month == "Aug")))
```

```{r}
ggplot(survival_environmental_data, aes(x = percent_alive, y = par_plot, group = community.y, color = community.y)) +
   geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "percent alive (%)",
       y = "par plot")

ggplot(survival_environmental_data, aes(x = percent_alive, y = par_ambient, group = community.y, color = community.y)) +
   geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "percent alive (%)",
       y = "par ambient")

ggplot(survival_environmental_data, aes(x = percent_alive, y = soil_moisture, group = community.y, color = community.y)) +
   geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "percent alive (%)",
       y = "soil moisture")

ggplot(survival_environmental_data, aes(x = percent_alive, y = par_prop, group = community.y, color = community.y)) +
   geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "percent alive (%)",
       y = "par prop")
```

## repeat all of the above but with height. 

```{r}
height_data <- read_xlsx(here("data", "piru_data_6.24.xlsx")) %>% 
  clean_names %>% 
  mutate(plot = plot_number,
         height = height_cm) %>% 
  select(plot, height, species, id, date, notes) %>% 
  fill(plot, .direction = "down")

environmental_summary <- environmental_data %>% 
  filter(date == "2022-06-09") %>% 
  group_by(plot) %>% 
  summarise(soil_moisture = mean(soil_moisture), 
            par_prop = mean(par_prop))

env_height_data <- height_data %>% 
  right_join(environmental_summary, by = c("plot"))
```

#summaries
```{r}
summary(lm(height ~ soil_moisture + par_prop + species, env_height_data))
```

```{r}
summary(lm(height ~ soil_moisture * species, data = env_height_data))
```

```{r}
summary(lm(height ~ par_prop * species, data = env_height_data))
```

```{r}
ggplot(env_height_data, aes(x = height, y = par_prop, group = species, color = species)) +
   geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "height",
       y = "par prop")

ggplot(env_height_data, aes(x = height, y = soil_moisture, group = species, color = species)) +
   geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "height",
       y = "soil moisture")
```






```{r}
plot_location_data <- read.csv(here("data", "survival.csv")) %>% 
  filter(date == "9/8/2022") %>% 
  select(1:6)%>% 
  mutate(species = case_when(species == "ADFA" ~ "adfa", 
                             species == "ARCA" ~ "arca",
                             species %in% c("E0CA", "E0FA", "ENCA") ~ "enca",
                             species %in% c("ERFA", "ERCA") ~ "erfa",
                             species == "HEAR" ~ "hear",
                             species %in% c("MALA", "AMALA", "MALA?", "MELA") ~ "mala",
                             species %in% c("RHOU", "RHOV", "RHOB") ~ "rhov",
                             species == "SAAP" ~ "saap",
                             species %in% c("SALE", "SALEU")~ "sale",
                             species %in% c("SAME", "SAAME") ~ "same",
                             species %in% c("CECU", "GECU") ~ "cecu",
                             species %in% c("CEOL", "EOL", " CEOL") ~ "ceol",
                             species %in% c("RHIL", "RAIL") ~ "rhil",
                             TRUE ~ species),
         alive = replace_na(alive, 0)) %>% 
  filter(species != "") %>% 
  rename(location = X0otes) %>% 
  group_by(plot, location) %>% 
  mutate(number_alive = sum(alive, na.rm = TRUE),
         location = case_when(location == "RM"~ "MR",
                              TRUE ~ location)) %>% 
  ungroup() %>% 
  select(!id & !alive & !date & !species) %>% 
  distinct() %>% 
  filter(location != "")
  group_by(location) %>% 
  summarise(mean = ci(number_alive)[1],
            lower = ci(number_alive)[2],
            upper = ci(number_alive)[3])

TukeyHSD(aov(number_alive~location, data = plot_location_data))  
  
ggplot(plot_location_data, aes(x = location, y = mean))+
  geom_point()+
  geom_errorbar(aes(ymin = lower, ymax = upper))
```



























